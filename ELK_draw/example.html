<div id="diagram"></div>
<a id="save" onclick="saveHDElkSvg()" href="javascript:void(0);">save</a>

<script src="js/elk.bundled.js"></script>
<script src="js/svg.min.js"></script>
<script src="js/hdelk.js"></script>
<script src="js/FileSaver.js"></script>

<script type="text/javascript">
    var svgId = "diagram";
    var dataStyle = 2;
    var cmdStyle = 1;
    var outClkStyle = 4;

    window.onload = function () {
        var a = document.getElementById("save");
        a.onclick = function () {
            saveHDElkSvg();
            return false;
        }
    }

    const getCurrentFile = () => {
        let url = window.location.href;
        let objs = url.split("/");
        return (objs[objs.length - 1]);
    }

    var saveHDElkSvg = function () {
        var snippetElement = document.getElementById(svgId);
        var snippetText = snippetElement.innerHTML;
        var blob = new Blob([snippetText], { type: "text/plain;charset=utf-8" });
        var filename = getCurrentFile()
        var nosuffix = filename.split(".")
        saveAs(blob, nosuffix[0] + ".svg");
    }

    var mygraph = {
        children: [
            {
                id: "Axi4AWGChannelWithCmdRam",
                inPorts: ["control", "cmd", "trigger"],
                outPorts: ["data", "output"],
                children: [
                    {
                        id: "busCtrl",
                        type: "AxiLite4SlaveFactory",
                        inPorts: ["control"],
                        outPorts: ["start"],
                    },
                    {
                        id: "channel",
                        type: "AWGChannel",
                        inPorts: ["cmdIn", "dataIn", "trigger", "start"],
                        outPorts: ["cmdAddr", "dataAddr", "cmdReset", "output"],
                        highlight: 1,
                        children: [
                            {
                                id: "controller",
                                type: "Controller",
                                inPorts: ["start", "cmdIn"],
                                outPorts: ["cmdAddr", "dataBlockAddr", "outCtrl", "cmdMemReset"],
                                highlight: 1,
                            },
                            {
                                id: "dma",
                                type: "AddressExtender",
                                inPorts: ["input"],
                                outPorts: ["output"],
                                highlight: dataStyle,
                            },
                            {
                                id: "output",
                                type: "OutputCtrl",
                                inPorts: ["command", "input", "trigger"],
                                outPorts: ["output"],
                                highlight: 1,
                            }
                        ],
                        edges: [
                            ["channel.start", "controller.start"],
                            ["channel.cmdIn", "controller.cmdIn", bus = 1],
                            ["controller.cmdAddr", "channel.cmdAddr", bus = 1],
                            ["controller.cmdMemReset", "channel.cmdReset"],
                            {
                                sources: ["controller.dataBlockAddr"],
                                targets: ["dma.input"],
                                highlight: dataStyle, bus: 1
                            },
                            {
                                sources: ["controller.outCtrl"],
                                targets: ["output.command"],
                                highlight: 1
                            },
                            {
                                sources: ["dma.output"],
                                targets: ["channel.dataAddr"],
                                highlight: dataStyle, bus: 1
                            },
                            {
                                sources: ["channel.dataIn"],
                                targets: ["output.input"],
                                highlight: dataStyle, bus: 1
                            },
                            {
                                sources: ["output.output"],
                                targets: ["channel.output"],
                                highlight: outClkStyle, bus: 1
                            },
                            {
                                sources: ["channel.trigger"],
                                targets: ["output.trigger"],
                                highlight: outClkStyle
                            },
                        ]
                    },
                    {
                        id: "cmdBridge",
                        type: "Mem2Axi4Bridge",
                        inPorts: ["addr"],
                        outPorts: ["Axi4Bus", "data"],
                    },
                    {
                        id: "dataBridge",
                        type: "Mem2Axi4Bridge",
                        inPorts: ["addr"],
                        outPorts: ["Axi4Bus", "data"],
                        highlight: dataStyle,
                    },
                    {
                        id: "ram",
                        type: "Axi4SharedOnChipRam",
                        inPorts: ["Axi4Write", "Axi4Read", "reset"],
                        // highlight: 1,
                    },
                    {
                        id: "extender",
                        type: "StreamTransactionExtender",
                        inPorts: ["input"],
                        outPorts: ["output"],
                        highlight: outClkStyle,
                    },

                ],
                edges: [
                    ["Axi4AWGChannelWithCmdRam.control", "busCtrl.control", bus = 1],
                    ["busCtrl.start", "channel.start"],

                    {
                        sources: ["channel.dataAddr"],
                        targets: ["dataBridge.addr"],
                        highlight: dataStyle, bus: 1
                    },
                    ["channel.cmdReset", "ram.reset"],
                    {
                        sources: ["dataBridge.data"],
                        targets: ["channel.dataIn"],
                        reverse: 1, bus: 1, highlight: dataStyle
                    },
                    ["channel.cmdAddr", "cmdBridge.addr", bus = 1],
                    {
                        sources: ["cmdBridge.data"],
                        targets: ["channel.cmdIn"],
                        reverse: 1, bus: 1
                    },

                    ["cmdBridge.Axi4Bus", "ram.Axi4Read", bus = 1],
                    {
                        sources: ["dataBridge.Axi4Bus"],
                        targets: ["Axi4AWGChannelWithCmdRam.data"],
                        bus: 1, highlight: dataStyle
                    },
                    ["Axi4AWGChannelWithCmdRam.cmd", "ram.Axi4Write", bus = 1],

                    {
                        sources: ["Axi4AWGChannelWithCmdRam.trigger"],
                        targets: ["channel.trigger"],
                        highlight: outClkStyle
                    },
                    {
                        sources: ["channel.output"],
                        targets: ["extender.input"],
                        highlight: outClkStyle, bus: 1
                    },
                    {
                        sources: ["extender.output"],
                        targets: ["Axi4AWGChannelWithCmdRam.output"],
                        highlight: outClkStyle, bus: 0
                    },
                ]
            },
        ],
    }

    hdelk.layout(mygraph, svgId);
</script>